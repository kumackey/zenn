---
title: "ã€PHPã€‘HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹"
emoji: "ğŸ“¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["PHP", "HTTP", "æ­£è¦è¡¨ç¾"]
published: true
---

# ãƒã‚¤ãƒ³ãƒˆãƒ»çµè«–

- ãƒ˜ãƒƒãƒ€ã¯`iconv_mime_decode_headers`ã¨ã„ã†ç¥parserãŒå­˜åœ¨ã™ã‚‹
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ã‚¤ãƒ³ã«ãŠã‘ã‚‹æ¨™æº–çš„ãªparserã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã®ã§æ­£è¦è¡¨ç¾ã‚’ä½¿ã£ãŸ
- HTTPã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯CRLFãŒæ¨™æº–ãªã®ã§ã€CRLFã§`explode`, `preg_match`ã‚’è¡Œã†

# ã‚µãƒ³ãƒ—ãƒ«ã‚±ãƒ¼ã‚¹

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹ã¯é©å½“ã«ãƒãƒƒãƒˆã®ã‚µãƒ³ãƒ—ãƒ«ã‚’æ‹¾ã‚ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚
â€» ä¸‹è¨˜ã¯LFã«ãªã£ã¡ã‚ƒã†ã‹ã‚‚ã§ã™ãŒã€HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯CRLFãªã®ã§ã€é©å®œCRLFã«æ›¿ãˆã¦ä¸‹ã•ã„ã€‚

```text:sample_http_200.txt
HTTP/1.1 200 OK
Date: Mon, 27 Jul 2009 12:28:53 GMT
Server: Apache/2.2.14 (Win32)
Last-Modified: Wed, 22 Jul 2009 19:15:56 GMT
Content-Length: 88
Content-Type: text/html
Connection: Closed

<html>
<body>
<h1>Hello, World!</h1>
</body>
</html>
```

```text:sample_http_400.txt
HTTP/1.1 404 Not Found
Date: Sun, 18 Oct 2012 10:36:20 GMT
Server: Apache/2.2.14 (Win32)
Content-Length: 230
Connection: Closed
Content-Type: text/html; charset=iso-8859-1

<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html>
<head>
   <title>404 Not Found</title>
</head>
<body>
   <h1>Not Found</h1>
   <p>The requested URL /t.html was not found on this server.</p>
</body>
</html>
```

# PHP

```php:http_parser.php
<?php

/**
 * @param string $response
 * @return array
 * @throws Exception
 */
function parse_http_response(string $response)
{
    list($headers, $body) = explode("\r\n\r\n", $response, 2);

    if (!preg_match('@HTTP/[0-9\.]+\s+([0-9]+)\s+(.*)\r\n@', $headers, $matches)) {
        throw new Exception('status line not found.');
    }

    $status_code = (int)$matches[1];
    $headers = iconv_mime_decode_headers($headers);

    return [
        'status_code' => $status_code,
        'headers' => $headers,
        'body' => $body,
    ];
}

var_dump(parse_http_response(file_get_contents(__DIR__ . '/sample_http_200.txt')));

echo PHP_EOL;

var_dump(parse_http_response(file_get_contents(__DIR__ . '/sample_http_400.txt')));
```

# çµæœ

```bash
php http_parser.php
array(3) {
  ["status_code"]=>
  int(200)
  ["headers"]=>
  array(6) {
    ["Date"]=>
    string(29) "Mon, 27 Jul 2009 12:28:53 GMT"
    ["Server"]=>
    string(21) "Apache/2.2.14 (Win32)"
    ["Last-Modified"]=>
    string(29) "Wed, 22 Jul 2009 19:15:56 GMT"
    ["Content-Length"]=>
    string(2) "88"
    ["Content-Type"]=>
    string(9) "text/html"
    ["Connection"]=>
    string(6) "Closed"
  }
  ["body"]=>
  string(56) "<html>
<body>
<h1>Hello, World!</h1>
</body>
</html>"
}

array(3) {
  ["status_code"]=>
  int(404)
  ["headers"]=>
  array(5) {
    ["Date"]=>
    string(29) "Sun, 18 Oct 2012 10:36:20 GMT"
    ["Server"]=>
    string(21) "Apache/2.2.14 (Win32)"
    ["Content-Length"]=>
    string(3) "230"
    ["Connection"]=>
    string(6) "Closed"
    ["Content-Type"]=>
    string(29) "text/html; charset=iso-8859-1"
  }
  ["body"]=>
  string(224) "<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html>
<head>
   <title>404 Not Found</title>
</head>
<body>
   <h1>Not Found</h1>
   <p>The requested URL /t.html was not found on this server.</p>
</body>
</html>"
}
```

# å‚è€ƒ

[PHP: iconv_mime_decode_headers - Manual](https://www.php.net/manual/en/function.iconv-mime-decode-headers.php)
[PHP: preg_match - Manual](https://www.php.net/manual/en/function.preg-match.php)
[HTTP/1.1: Response](https://www.w3.org/Protocols/rfc2616/rfc2616-sec6.html)
