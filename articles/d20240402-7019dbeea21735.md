---
title: "Goã§ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã‚’ç›®çš„ã¨ã—ãŸå ´åˆã®æœ€å°é™ã®DIè¨­è¨ˆ"
emoji: "ğŸ’‰"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [ "Golang", "DI", "ãƒ†ã‚¹ãƒˆ" ]
published: true
---

# èª°ã«å¯¾ã—ã¦å‘ã‘ãŸè¨˜äº‹ã‹

- Clean Architectureçš„ãªæ€æƒ³ã§ä¾å­˜é–¢ä¿‚ã‚’é€†è»¢ã•ã›ãŸç¶ºéº—ãªè¨­è¨ˆã«ã™ã‚‹ã®ã¯ã¶ã£ã¡ã‚ƒã‘é¢å€’ãã›ãˆ
- ã§ã‚‚ãƒ†ã‚¹ãƒˆã®ãŸã‚ã«DIã‚„mockã¯ã—ãªãã¡ã‚ƒã„ã‘ã­ãˆ

ã£ã¦äººã®ãŸã‚ã®è¨˜äº‹ã§ã™ã€‚

# ä½•ã‚’è§£èª¬ã™ã‚‹è¨˜äº‹ã‹

Goã§ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã‚’ç›®çš„ã¨ã—ãŸå ´åˆã®æœ€å°é™ã®DIè¨­è¨ˆã‚’2ã¤ç´¹ä»‹ã—ã¾ã™ã€‚

- funcã‚’å¼•æ•°ã«å–ã‚‹æ–¹æ³•
- interfaceã‚’ä½¿ã†æ–¹æ³•

# å•é¡Œã®ä¾‹

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ãŸã¨ã—ã¾ã™ã€‚
è¦ã¯`Veryè‰²ã‚“ãªå‡¦ç†`ãŒçµ‚ã‚ã£ãŸã‚‰Slacké€šçŸ¥ã‚’è¡Œã†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚

```go
package main

import (
	"fmt"
	"github.com/slack-go/slack"
	"os"
)

func main() {
	c := slack.New(os.Getenv("SLACK_TOKEN"))

	err := Veryè‰²ã‚“ãªå‡¦ç†()
	msg, err := HandleErrorV1(c, err)
	if err != nil {
		panic(err)
	}

	fmt.Println(msg)
}

func HandleErrorV1(c *slack.Client, err error) (string, error) {
	var msg string
	if err == nil {
		msg = "Veryè‰²ã‚“ãªå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ\n"
	} else {
		msg = fmt.Sprintf("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: %v\n", err)
	}

	if _, _, err = c.PostMessage("#general", slack.MsgOptionText(msg, true)); err != nil {
		return "", fmt.Errorf("slackã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: %v", err)
	}

	return msg, nil
}

func Veryè‰²ã‚“ãªå‡¦ç†() error {
	// å®Ÿéš›ã«ã¯ã‚ã£ã¡ã‚ƒè‰²ã‚“ãªå‡¦ç†ãŒã“ã“ã«æ›¸ã‹ã‚Œã¦ã‚‹ã“ã¨ã«ã—ã¦ãã ã•ã„
	return nil
}
```

ã“ã®ä¸­ã®`HandleErrorV1`ã‚’ãƒ†ã‚¹ãƒˆã—ãŸã„ã¨ã—ã¾ã™ã€‚
ã—ã‹ã—ã€`HandleErrorV1`ã¯`slack.Client`ã«ä¾å­˜ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ†ã‚¹ãƒˆã‚’èµ°ã‚‰ã›ã‚‹ãŸã³ã«Slackã«é€šçŸ¥ãŒé£›ã‚“ã§ã—ã¾ã„ã¾ã™ã€‚

# è§£æ±ºæ¡ˆ funcã‚’å¼•æ•°ã«å–ã‚‹æ–¹æ³•

ã€Œå•é¡Œã®ä¾‹ã€ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

```go
package main

import (
	"fmt"
	"github.com/slack-go/slack"
	"os"
)

func main() {
	err := Veryè‰²ã‚“ãªå‡¦ç†()
	msg, err := HandleErrorV2(err, PostMessageImpl) // ã“ã“ã§æ³¨å…¥
	if err != nil {
		panic(err)
	}

	fmt.Println(msg)
}

// å¼•æ•°ã®funcã«ã¦DIã£ã½ã„ã“ã¨ã‚’å®Ÿç¾ã™ã‚‹
func HandleErrorV2(err error, postMessage func(string, slack.MsgOption) (string, string, error)) (string, error) {
	var msg string
	if err == nil {
		msg = "Veryè‰²ã‚“ãªå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ\n"
	} else {
		msg = fmt.Sprintf("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: %v\n", err)
	}

	if _, _, err = postMessage("#general", slack.MsgOptionText(msg, true)); err != nil {
		return "", fmt.Errorf("slackã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: %v", err)
	}

	return msg, nil
}

func PostMessageImpl(channel string, msgOption slack.MsgOption) (string, string, error) {
	return slack.New(os.Getenv("SLACK_TOKEN")).PostMessage(channel, msgOption)
}

func Veryè‰²ã‚“ãªå‡¦ç†() error {
	// å®Ÿéš›ã«ã¯ã‚ã£ã¡ã‚ƒè‰²ã‚“ãªå‡¦ç†ãŒã“ã“ã«æ›¸ã‹ã‚Œã¦ã‚‹ã“ã¨ã«ã—ã¦ãã ã•ã„
	return nil
}
```

ä»¥ä¸‹ã®ç‰¹å¾´ãŒã‚ã‚Šã¾ã™ã€‚

- `HandleErrorV2`ã¯`slack.Client`ã«ä¾å­˜ã›ãšã€`PostMessage`ã¨ã„ã†é–¢æ•°ã‚’å¼•æ•°ã«å–ã‚‹ã“ã¨ã§DIã‚’å®Ÿç¾ã—ã¦ã„ã‚‹
- `HandleErrorV2`ã®ä½¿ç”¨å´ã§`PostMessageImpl`ã‚’æ³¨å…¥ã™ã‚‹

ã“ã‚Œã«ã‚ˆã‚Šã€`HandleErrorV2`ã®ãƒ†ã‚¹ãƒˆã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

```go
package main

import (
	"errors"
	"github.com/slack-go/slack"
	"github.com/stretchr/testify/assert"
	"testing"
)

func TestHandleErrorV2(t *testing.T) {
	mockPostMessage := func(channel string, msgOption slack.MsgOption) (string, string, error) {
		// å®Ÿéš›ã®é€šçŸ¥ã‚’ã•ã›ãšã€ä½•ã‚‚èµ·ã“ã•ãªã„
		return "", "", nil
	}

	msg, err := HandleErrorV2(errors.New("ä½•ã‹ã—ã‚‰ã®ã‚¨ãƒ©ãƒ¼"), mockPostMessage)
	assert.Nil(t, err)
	assert.Equal(t, "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ä½•ã‹ã—ã‚‰ã®ã‚¨ãƒ©ãƒ¼\n", msg)
}

```

# è§£æ±ºæ¡ˆ interfaceã‚’ä½¿ã†æ–¹æ³•

ã¾ãŸã€interfaceã‚’ä½¿ã†æ–¹æ³•ã‚‚ç´¹ä»‹ã—ã¾ã™ã€‚
Goã§ã‚ã‚Œã°ã§ãã‚‹è¨­è¨ˆã§ã‚ã‚Šã€æœ€å°é™ã®å®šç¾©ã ã‘ã§å®Ÿç¾ã§ãã¾ã™ã€‚

```go
package main

import (
	"fmt"
	"github.com/slack-go/slack"
	"os"
)

func main() {
	c := slack.New(os.Getenv("SLACK_TOKEN"))

	err := Veryè‰²ã‚“ãªå‡¦ç†()
	msg, err := HandleErrorV3(err, c)
	if err != nil {
		panic(err)
	}

	fmt.Println(msg)
}

func HandleErrorV3(err error, slackClient slackClientInterface) (string, error) {
	var msg string
	if err == nil {
		msg = "Veryè‰²ã‚“ãªå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ\n"
	} else {
		msg = fmt.Sprintf("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: %v\n", err)
	}

	if _, _, err = slackClient.PostMessage("#general", slack.MsgOptionText(msg, true)); err != nil {
		return "", fmt.Errorf("slackã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: %v", err)
	}

	return msg, nil
}

type slackClientInterface interface {
	// ä»¥ä¸‹ã®ã‚·ã‚°ãƒãƒãƒ£ã‚’interfaceã¨ã—ã¦å®šç¾©ã—ãŸã ã‘
	// https://pkg.go.dev/github.com/slack-go/slack#Client.PostMessage
	// Goã¯æ˜ç¤ºçš„ãªimplementsãŒä¸è¦ãªã®ã§ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«åˆã†interfaceã‚’ã“ã¡ã‚‰ã§å‹æ‰‹ã«å®šç¾©ã—ã¦ä½¿ãˆã‚‹
	PostMessage(channelID string, options ...slack.MsgOption) (string, string, error)
}

func Veryè‰²ã‚“ãªå‡¦ç†() error {
	// å®Ÿéš›ã«ã¯ã‚ã£ã¡ã‚ƒè‰²ã‚“ãªå‡¦ç†ãŒã“ã“ã«æ›¸ã‹ã‚Œã¦ã‚‹ã“ã¨ã«ã—ã¦ãã ã•ã„
	return nil
}

```

ä»¥ä¸‹ã®ç‰¹å¾´ãŒã‚ã‚Šã¾ã™ã€‚

- `HandleErrorV3`ã¯`slack.Client`ã«ä¾å­˜ã›ãšã€`slackClientInterface`ã¨ã„ã†ç‹¬è‡ªå®šç¾©ã®interfaceã‚’å¼•æ•°ã«å–ã‚‹ã“ã¨ã§DIã‚’å®Ÿç¾ã—ã¦ã„ã‚‹
- `slackClientInterface`ã¯`slack.Client`ã®`PostMessage`ãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚·ã‚°ãƒãƒãƒ£ã‚’ãã®ã¾ã¾å®šç¾©ã—ã¦ã„ã‚‹ã ã‘
- `slack.Client`ã¯`slackClientInterface`ã‚’å®Ÿè£…ã—ãŸã“ã¨ã«ãªã£ã¦ã‚‹(Goã¯æ˜ç¤ºçš„ãªimplementsãŒä¸è¦
- `HandleErrorV3`ã®ä½¿ç”¨å´ã§`slackClientInterface`ã‚’å®Ÿè£…ã—ãŸå‹ã§ã‚ã‚‹`slack.Client`ã‚’æ³¨å…¥ã™ã‚‹

ã“ã‚Œã«ã‚ˆã‚Šã€`HandleErrorV3`ã®ãƒ†ã‚¹ãƒˆã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

```go
package main

import (
	"errors"
	"github.com/slack-go/slack"
	"github.com/stretchr/testify/assert"
	"testing"
)

type mockSlackClient struct{}

func (m *mockSlackClient) PostMessage(channelID string, options ...slack.MsgOption) (string, string, error) {
	// å®Ÿéš›ã®é€šçŸ¥ã‚’ã•ã›ãšã€ä½•ã‚‚èµ·ã“ã•ãªã„
	return "", "", nil
}

func TestHandleErrorV2(t *testing.T) {
	msg, err := HandleErrorV3(errors.New("ä½•ã‹ã—ã‚‰ã®ã‚¨ãƒ©ãƒ¼"), &mockSlackClient{})
	assert.Nil(t, err)
	assert.Equal(t, "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ä½•ã‹ã—ã‚‰ã®ã‚¨ãƒ©ãƒ¼\n", msg)
}

```
